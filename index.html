<!DOCTYPE html>
<html>
<head>
    <title>Lunch Ticket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            background-color: #000000;
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) 
                    env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #consent-container {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            flex-direction: column;
            gap: 15px;
        }

        #consent-container h2 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
        }

        #consent-container p {
            margin: 0;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        #qr-container {
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 10px;
        }

        img { 
            width: 80vmin; 
            height: 80vmin; 
            max-width: 300px; 
            max-height: 300px; 
            display: block;
        }
        
        #date-text {
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }

        #user-info {
            color: white;
            text-align: center;
            margin-bottom: 10px;
        }

        #user-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }

        #user-info p {
            margin: 0;
            font-size: 12px;
            opacity: 0.7;
        }

        .google-btn {
            background-color: white;
            color: #444;
            border: none;
            border-radius: 4px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25);
            transition: box-shadow 0.2s;
        }

        .google-btn:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .google-btn img {
            width: 18px;
            height: 18px;
        }

        .consent-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }

        .consent-btn:hover {
            background-color: #3367d6;
        }

        .cancel-btn {
            background-color: transparent;
            color: #666;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .cancel-btn:hover {
            background-color: #f5f5f5;
        }

        .logout-btn {
            background-color: transparent;
            color: #666;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background-color: #f5f5f5;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 5px;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        #loading {
            color: white;
            font-size: 14px;
        }

        /* Responsive design for small screens */
        @media (max-width: 300px) {
            #qr-container, #consent-container { 
                padding: 6px; 
                border-radius: 8px;
            }
            #date-text { 
                font-size: 11px; 
            }
            .google-btn { 
                padding: 10px 20px; 
                font-size: 14px; 
            }
            .logout-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            #user-info h3 { 
                font-size: 14px; 
            }
            #user-info p {
                font-size: 10px;
            }
            #consent-container h2 {
                font-size: 16px;
            }
            #consent-container p {
                font-size: 12px;
            }
            .consent-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }

        /* Smart watch and very small screens */
        @media (max-width: 200px), (max-height: 200px) {
            #qr-container, #consent-container { 
                padding: 4px; 
                border-radius: 6px;
                gap: 6px;
            }
            #date-text { 
                font-size: 9px; 
            }
            .google-btn { 
                padding: 8px 14px; 
                font-size: 12px; 
                gap: 6px;
            }
            .google-btn img {
                width: 14px;
                height: 14px;
            }
            .logout-btn {
                padding: 4px 10px;
                font-size: 9px;
                margin-top: 6px;
            }
            .consent-btn {
                padding: 8px 14px;
                font-size: 12px;
            }
            .cancel-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            #user-info {
                margin-bottom: 6px;
            }
            #user-info h3 { 
                font-size: 11px; 
                margin-bottom: 2px;
            }
            #user-info p {
                font-size: 9px;
            }
            #auth-container {
                gap: 12px;
            }
            #loading {
                font-size: 11px;
            }
            #consent-container h2 {
                font-size: 13px;
            }
            #consent-container p {
                font-size: 10px;
            }
        }

        /* Landscape orientation on phones */
        @media (orientation: landscape) and (max-height: 500px) {
            body {
                flex-direction: row;
                padding: 20px;
            }
            #user-info {
                margin-bottom: 0;
                margin-right: 20px;
                max-width: 200px;
            }
            #qr-container, #consent-container {
                flex-shrink: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script type="module">
        console.log('ðŸš€ Lunch Ticket v2.0 - Page loaded at:', new Date().toLocaleTimeString());
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc,
            updateDoc,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA83pUpJas-Uy7W-8Bq88RtnkhbWmW2GYo",
            authDomain: "lunchkod1239123.firebaseapp.com",
            projectId: "lunchkod1239123",
            storageBucket: "lunchkod1239123.firebasestorage.app",
            messagingSenderId: "198521085351",
            appId: "1:198521085351:web:85bbdd3bf00a3d62462a82"
        };

        // Initialize Firebase
        console.log('ðŸ”§ Initializing Firebase...');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        console.log('âœ… Firebase initialized');

        // UI Elements
        const authContainer = document.getElementById('auth-container');
        const consentContainer = document.getElementById('consent-container');
        const qrContainer = document.getElementById('qr-container');
        const loading = document.getElementById('loading');
        const userInfo = document.getElementById('user-info');
        const qrImg = document.getElementById('qr');
        const dateDisplay = document.getElementById('date-display');
        
        let currentUser = null;
        let currentGoogleId = null;

        // Generate QR code with user ID
        function generateQR(userId) {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            const fullString = `:${month}${day};${userId}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&margin=0&data=${encodeURIComponent(fullString)}`;
            
            qrImg.src = qrUrl;
            dateDisplay.innerText = `${month}/${day}`;
        }

        // Show QR view
        function showQR(user) {
            consentContainer.style.display = 'none';
            authContainer.style.display = 'none';
            loading.style.display = 'none';
            qrContainer.style.display = 'flex';
            
            userInfo.innerHTML = `
                <h3>${user.displayName || 'User'}</h3>
                <p>${user.email}</p>
            `;
            
            generateQR(currentGoogleId);
        }

        // Show consent view
        function showConsent(user) {
            authContainer.style.display = 'none';
            qrContainer.style.display = 'none';
            loading.style.display = 'none';
            consentContainer.style.display = 'flex';
            consentContainer.style.flexDirection = 'column';
        }

        // Show login view
        function showLogin() {
            console.log('ðŸ‘¤ Showing login view');
            consentContainer.style.display = 'none';
            authContainer.style.display = 'flex';
            loading.style.display = 'none';
            qrContainer.style.display = 'none';
        }

        // Check if user has already consented
        async function checkConsent(user) {
            try {
                const consentDoc = await getDoc(doc(db, 'user_consents', user.uid));
                return consentDoc.exists();
            } catch (error) {
                console.error('Error checking consent:', error);
                return false;
            }
        }

        // Save consent to Firestore
        async function saveConsent(user) {
            try {
                const googleProvider = user.providerData.find(p => p.providerId === 'google.com');
                const googleId = googleProvider?.uid || user.uid;
                currentGoogleId = googleId;
                
                await setDoc(doc(db, 'user_consents', user.uid), {
                    googleId: googleId,
                    email: user.email,
                    displayName: user.displayName,
                    consentedAt: serverTimestamp(),
                    lastUsed: serverTimestamp()
                });
                
                console.log('âœ… Consent saved for:', user.email);
                return true;
            } catch (error) {
                console.error('Error saving consent:', error);
                return false;
            }
        }

        // Google Sign In
        window.signInWithGoogle = async function() {
            try {
                loading.style.display = 'block';
                authContainer.style.display = 'none';
                
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                
                console.log('Signed in:', currentUser.email);
                
                // Check if user has already consented
                const hasConsented = await checkConsent(currentUser);
                
                if (hasConsented) {
                    // Get their Google ID and show QR
                    const googleProvider = currentUser.providerData.find(p => p.providerId === 'google.com');
                    currentGoogleId = googleProvider?.uid || currentUser.uid;
                    
                    // Update last used timestamp
                    await updateDoc(doc(db, 'user_consents', currentUser.uid), {
                        lastUsed: serverTimestamp()
                    });
                    
                    showQR(currentUser);
                } else {
                    // Show consent screen
                    showConsent(currentUser);
                }
                
            } catch (error) {
                console.error('Sign in error:', error);
                showLogin();
                alert('Sign in failed: ' + error.message);
            }
        };

        // Handle consent agreement
        window.agreeConsent = async function() {
            if (!currentUser) return;
            
            loading.style.display = 'block';
            consentContainer.style.display = 'none';
            
            const saved = await saveConsent(currentUser);
            
            if (saved) {
                showQR(currentUser);
            } else {
                alert('Failed to save consent. Please try again.');
                showConsent(currentUser);
            }
        };

        // Handle consent decline
        window.declineConsent = async function() {
            if (!currentUser) return;
            
            // Sign them out
            await signOut(auth);
            currentUser = null;
            currentGoogleId = null;
            alert('Consent is required to access your lunch ticket. You have been signed out.');
            showLogin();
        };

        // Delete user data
        window.deleteMyData = async function() {
            if (!currentUser) return;
            
            if (!confirm('Are you sure you want to delete your data? You will need to consent again to use the lunch ticket.')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'user_consents', currentUser.uid));
                console.log('User data deleted:', currentUser.email);
                
                // Sign them out
                await signOut(auth);
                currentUser = null;
                currentGoogleId = null;
                alert('Your data has been deleted. You have been signed out.');
                showLogin();
            } catch (error) {
                console.error('Error deleting data:', error);
                alert('Failed to delete data. Please try again.');
            }
        };

        // Sign Out
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                currentUser = null;
                currentGoogleId = null;
                showLogin();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        // Listen for auth state changes
        console.log('ðŸ‘‚ Setting up auth state listener...');
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log('ðŸ”„ Auth state changed: LOGGED IN as', user.email);
                
                // Check if they've consented
                const hasConsented = await checkConsent(user);
                
                if (hasConsented) {
                    const googleProvider = user.providerData.find(p => p.providerId === 'google.com');
                    currentGoogleId = googleProvider?.uid || user.uid;
                    showQR(user);
                } else {
                    showConsent(user);
                }
            } else {
                currentUser = null;
                currentGoogleId = null;
                console.log('ðŸ”„ Auth state changed: NOT LOGGED IN');
                showLogin();
            }
        });
    </script>

    <!-- Loading State -->
    <div id="loading" style="display: none;">Loading...</div>

    <!-- Auth View -->
    <div id="auth-container">
        <button class="google-btn" onclick="signInWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
            Sign in with Google
        </button>
    </div>

    <!-- Consent View -->
    <div id="consent-container">
        <h2>Help Desk Access</h2>
        <p>We store your Google ID to help debug lunch ticket issues.</p>
        <p>Data stored: Google ID, Email, Consent timestamp</p>
        <p>Data retained indefinitely. You can delete your data anytime.</p>
        <button class="consent-btn" onclick="agreeConsent()">I Agree & Continue</button>
        <button class="cancel-btn" onclick="declineConsent()">Cancel</button>
    </div>

    <!-- QR View -->
    <div id="user-info"></div>
    <div id="qr-container">
        <img id="qr" src="" alt="QR Code" />
        <div id="date-display"></div>
        <button class="logout-btn" onclick="signOutUser()">Sign Out</button>
        <button class="delete-btn" onclick="deleteMyData()">Delete My Data</button>
    </div>
</body>
</html>
